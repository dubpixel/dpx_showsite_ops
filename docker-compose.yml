name: dpx-govee-stack

services:
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
    networks:
      - iot

  govee2mqtt:
    image: ghcr.io/wez/govee2mqtt:latest
    container_name: govee2mqtt
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env
    
    environment:
      TZ: America/New_York
    volumes:
      - govee2mqtt-data:/data

  influxdb:
    image: influxdb:2
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=influxpass123
      - DOCKER_INFLUXDB_INIT_ORG=home
      - DOCKER_INFLUXDB_INIT_BUCKET=sensors
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-token
    networks:
      - iot

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro    
      # Map to both standard and build locations to cover all bases
      - ./images/login_logo.svg:/usr/share/grafana/public/img/grafana_icon.svg:ro
      - ./images/login_logo.svg:/usr/share/grafana/public/build/img/grafana_icon.1e0deb6b.svg:ro
      - ./images/menu_logo.svg:/usr/share/grafana/public/img/grafana_typelogo.svg:ro
      - ./images/menu_logo.svg:/usr/share/grafana/public/build/img/grafana_typelogo.svg:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      
      # Favicon (which you said is working, keep this)
      - ./images/fav_icon.png:/usr/share/grafana/public/img/fav32.png:ro
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=grafanapass123
    networks:
      - iot
  telegraf:
    build:
      context: .
      dockerfile: Dockerfile.telegraf
    image: telegraf-snmp:latest
    container_name: telegraf
    restart: unless-stopped
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ./telegraf/conf.d:/etc/telegraf/telegraf.d:ro
      - ./telegraf/mibs:/usr/share/snmp/mibs:ro
    command: --config /etc/telegraf/telegraf.conf --config-directory /etc/telegraf/telegraf.d
    environment:
      - TZ=${TZ}
    extra_hosts:
      - "dpx-geist.local:192.168.1.214"
    networks:
      - iot

  ble-decoder:
    build:
      context: .
      dockerfile: Dockerfile.ble-decoder
    container_name: ble-decoder
    restart: unless-stopped
    volumes:
      - ./telegraf/conf.d:/app/telegraf/conf.d:ro
    environment:
      - BROKER=mosquitto
      - GOVEE_API_URL=http://host.docker.internal:8056/api/devices
      - SHOWSITE_NAME=${SHOWSITE_NAME:-demo_showsite}
      - TZ=${TZ}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - iot
    depends_on:
      - mosquitto
      - govee2mqtt

  set-schedule:
    build:
      context: ./services/set-schedule
      dockerfile: Dockerfile
    container_name: set-schedule
    restart: unless-stopped
    ports:
      - "${SCHEDULE_PORT:-8000}:8000"
    environment:
      - HOST=0.0.0.0
      - PORT=8000
      - USE_GOOGLE_SHEETS=${USE_GOOGLE_SHEETS:-false}
      - STAGE_NAME=${STAGE_NAME:-Main Stage}
      - TIMEZONE=${TIMEZONE:-America/Los_Angeles}
      - GOOGLE_SHEETS_ID=${GOOGLE_SHEETS_ID}
      - GOOGLE_SHEET_TAB=${GOOGLE_SHEET_TAB:-Schedule}
      - GOOGLE_SERVICE_ACCOUNT_FILE=${GOOGLE_SERVICE_ACCOUNT_FILE:-/app/secret/set-schedule-service-account.json}
      - ARTNET_ENABLED=${ARTNET_ENABLED:-false}
      - ARTNET_LISTEN_IP=${ARTNET_LISTEN_IP:-0.0.0.0}
      - ARTNET_PORT=${ARTNET_PORT:-6454}
      - ARTNET_UNIVERSE=${ARTNET_UNIVERSE:-0}
      - ARTNET_CHANNEL_START=${ARTNET_CHANNEL_START:-1}
      - ARTNET_CHANNEL_COUNT=${ARTNET_CHANNEL_COUNT:-3}
    volumes:
      - ./secret:/app/secret:ro
    networks:
      - iot

  tftp-server:
    image: pghalliday/tftp:latest
    container_name: tftp-server
    restart: unless-stopped
    ports:
      - "69:69/udp"
    volumes:
      - tftp-data:/var/tftpboot
    environment:
      # Temporary IP until management VLAN deployed
      - BIND_ADDRESS=0.0.0.0
    networks:
      - iot

  netgear-backup:
    build:
      context: ./services/netgear-backup
      dockerfile: Dockerfile
    container_name: netgear-backup
    restart: "no"  # Manual/cron triggered, not always-on
    environment:
      - M4300_USERNAME=${M4300_USERNAME}
      - M4300_PASSWORD_M4300=${M4300_PASSWORD_M4300}
      - M4300_PASSWORD_OTHER=${M4300_PASSWORD_OTHER}
      - M4300_TFTP_SERVER=tftp-server
      - M4300_BACKUP_DIR=/backups
      - INFLUXDB_URL=${INFLUXDB_URL:-http://influxdb:8086}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-home}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-sensors}
    volumes:
      - netgear-backups:/backups
      - ./services/netgear-backup/switches.conf:/config/switches.conf:ro
    networks:
      - iot
    depends_on:
      - tftp-server
      - influxdb

networks:
  iot:
    driver: bridge

volumes:
  govee2mqtt-data:
  influxdb-data:
  grafana-data:
  tftp-data:
  netgear-backups:
