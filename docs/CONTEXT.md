# dpx-showsite-ops - Full Project Context
# Phase 3 Complete → Phase 4, 5, 6 Ready
# Last updated: 2026-02-05
# Upload this file to a new Claude chat to continue where we left off

---

## CURRENT STATUS

**Phase 3: COMPLETE ✅**
- Repository structure finalized and pushed to GitHub
- All documentation written (README, ROADMAP, ARCHITECTURE, GRAFANA_SETUP, CHANGELOG)
- Deployment automation working (setup.sh, manage.sh)
- File organization complete (scripts in scripts/ directory)
- Version controlled: https://github.com/dubpixel/dpx_showsite_ops (public repo)

**Phase 4 - BLE Gateway Integration (In Progress - ESP32 Hardware Live)**
- ESP32 BLE gateways deployed (OpenMQTTGateway firmware)
- Deploy ble_decoder.py as systemd service
- Unified Telegraf config with source tagging (cloud + BLE)
- Update Grafana dashboards to show both sources
- Theengs Gateway available as Windows fallback option

**Phase 5 - Network Device Backups (After Phase 4)**
- TFTP server setup
- M4300 switch backup automation
- Monitoring integration

**Phase 6 - Set Schedule Integration (NEW)**
- Add Sean's coachella_set_schedule as git submodule
- Deploy as Docker service
- Real-time show schedule tracking
- WebSocket updates across clients

---

## ENVIRONMENT

- **VM**: Ubuntu Server 24.04 on Hyper-V (NUC Windows host)
- **Hostname**: dpx-showsite-ops (changed from dpx-coachella-ops in Phase 2.7)
- **IP**: <server-ip> (static)
- **mDNS**: dpx-showsite-ops.local
- **User**: dubpixel
- **Stack dir**: ~/dpx_govee_stack/ (local folder name, GitHub repo is dpx_showsite_ops)
- **Backups**: ~/backups/
- **GitHub**: https://github.com/dubpixel/dpx_showsite_ops (public repo)

---

## CREDENTIALS

- **Grafana**: (see .env) @ http://<server-ip>:3000
- **InfluxDB**: (see .env) @ http://<server-ip>:8086
- **MQTT**: anonymous @ <server-ip>:1883
- **Govee**: (see .env — do NOT commit)
- **govee2mqtt web API**: http://localhost:8056/api/devices
- **Git**: i@dubpixel.tv / dubpixel

---

## REMOTE ACCESS

- **Tailscale**: Installed on VM + user's Mac, mesh VPN for SSH from anywhere
- **Cloudflare Tunnel**: `iot tunnel` for temporary public dashboard sharingF1b
- **Public dashboard**: Requires Cloudflare Tunnel or port forwarding to work

---

## DEVICE INVENTORY

### H5051 Thermometer (BLE-only)
- **MAC**: 33:FA:43:81:EC:A1:01:0A
- **Room**: StuDown (Studio Downstairs)
- **Name**: "Studio 5051 Down"
- **Type**: BLE only, no LAN API, no IoT API
- **ble_only**: true
- **Broadcast**: BLE every ~1min, uploads to cloud every ~10min via phone/gateway

### H6076 Floor Lamp (BLE + LAN)
- **MAC**: 17:A8:D0:03:C1:06:19:76
- **LAN IP**: 192.168.1.28
- **Room**: Unassigned
- **Type**: Supports LAN API, auto-discovered, WiFi connected
- **Broadcast**: BLE every ~1min, uploads to cloud every ~10min via WiFi

### Unknown Device
- **MAC**: A8:46:74:1A:65:62
- Shows up in BLE scans, not yet identified

### ESP32 BLE Gateway (Phase 4 Hardware)
- **Board**: Custom ESP32-based hardware (DPX boards)
- **Firmware**: OpenMQTTGateway v1.8+ (esp32feather-ble build)
- **Flash Method**: Web installer at https://docs.openmqttgateway.com/upload/web-install.html
- **MQTT Topics**: Publishes to `home/OpenMQTTGateway/BTtoMQTT/{MAC}` (raw BLE)
- **Purpose**: Real-time BLE collection (<5 sec latency) from Govee sensors
- **Status**: ✅ Gateway 1 deployed and publishing
- **Config**: WiFi + MQTT broker at <server-ip>:1883

**Quick Setup**:
1. Open web installer, select **esp32feather-ble** firmware
2. Flash to board (2-3 min)
3. Connect to "OpenMQTTGateway" WiFi, configure at 192.168.4.1
4. Set WiFi SSID/password + MQTT broker IP
5. Verify: `iot mqtt "home/OpenMQTTGateway/BTtoMQTT/#" 10`

**Fallback**: Theengs Gateway on Windows (see THEENGS GATEWAY section)

---

## FILE STRUCTURE (as of Phase 3 completion)

```
~/dpx_govee_stack/              (local directory)
├── README.md                   ← Quick start guide
├── CHANGELOG.md                ← Version history
├── docker-compose.yml          ← Main stack definition
├── .env                        ← Secrets (gitignored)
├── .env.example                ← Template for users
├── .gitignore                  ← Excludes secrets, logs, backups
├── setup.sh                    ← Initial deployment script
├── mosquitto/
│   └── config/
│       └── mosquitto.conf
├── telegraf/
│   ├── telegraf.conf           ← Auto-generated by update-device-map.sh
│   └── backups/                ← Last 10 config backups
├── scripts/
│   ├── manage.sh               ← Main management CLI
│   ├── update-device-map.sh    ← Hourly device mapping updates
│   └── update-device-map.log   ← Update script log
└── docs/
    ├── ARCHITECTURE.md         ← Technical deep dive
    ├── ROADMAP.md              ← Phase plans and timeline
    ├── GRAFANA_SETUP.md        ← Manual Grafana configuration guide
    └── SETUP_GUIDE_COMPLETE.md ← Complete idiot-proof guide from zero
└── images/
    ├── architecture.png        ← Architecture diagram
    ├── grafana-dashboard.png   ← Screenshot
    ├── logo.png                ← Project logo
    └── dubpixel_identicon.png  ← Identity icon
```

**Planned Phase 6 addition**:
```
└── services/
    └── set-schedule/           ← Sean's repo as git submodule
        ├── (his files here)
        └── Dockerfile.showsite ← Custom Dockerfile for integration
```

**Not tracked in git** (gitignored):
- .env (actual credentials)
- .env_bu (backup)
- *.log files
- backups/
- hostname
- *.backup files

---

## KNOWN ISSUES & FIXES

### IPv6 causing govee2mqtt AWS IoT timeouts (SOLVED)
govee2mqtt kept timing out connecting to AWS IoT (port 8883). Error:
"timeout connecting to IoT aqm3wd1qlc3dy-ats.iot.us-east-1.amazonaws.com:8883"

**Root cause:** AWS IoT endpoint resolves to both IPv4 and IPv6. System prefers IPv6 but Hyper-V network can't route IPv6 to internet. govee2mqtt uses host networking so it inherits the host's IPv6 preference and hangs.

**Fix:** Disable IPv6 on eth0 at kernel level:
```bash
sudo sysctl -w net.ipv6.conf.eth0.disable_ipv6=1
echo "net.ipv6.conf.eth0.disable_ipv6=1" | sudo tee -a /etc/sysctl.conf
```

**Previous red herrings that didn't fully fix it:**
- IPv6 disabled in /etc/docker/daemon.json — doesn't help because govee2mqtt uses network_mode: host
- `sudo tailscale down && iot restart govee2mqtt` — sometimes worked, inconsistent
- Waiting 10-15 min — intermittent success

### Telegraf "Available" parse errors (HARMLESS)
Telegraf logs spam: `strconv.ParseFloat: parsing "Available": invalid syntax`
This is govee2mqtt publishing status messages on same topics. Data still flows. Fix later with topic filtering.

### Telegraf restarting hourly (NOT A CRASH)
The update-device-map.sh cron job runs hourly and restarts telegraf if config changed. Check log:
```bash
cat ~/dpx_govee_stack/scripts/update-device-map.log | tail -5
```

### Docker logs lost on recreate
`docker compose down && up` wipes logs (new container ID). No fix currently — just be aware. Use `iot restart` instead when possible.

### iot command requires wrapper script (NOT SYMLINK)
Direct symlink doesn't work - bash resolves `${BASH_SOURCE[0]}` incorrectly. Must use wrapper script:
```bash
sudo tee /usr/local/bin/iot > /dev/null << 'WRAPPER'
#!/bin/bash
cd /home/dubpixel/dpx_govee_stack
exec /home/dubpixel/dpx_govee_stack/scripts/manage.sh "$@"
WRAPPER
sudo chmod +x /usr/local/bin/iot
```

---

## MANAGEMENT CLI (iot command)

Symlinked: /usr/local/bin/iot → wrapper script → ~/dpx_govee_stack/scripts/manage.sh

**Commands:**
```bash
# Stack control
iot up                          # Start all containers
iot down                        # Stop all containers
iot restart [service]           # Restart service(s)
iot status                      # Show container status
iot validate                    # Check stack configuration

# Logs (n = line count, default 30)
iot lg [n]                      # govee2mqtt logs
iot lt [n]                      # telegraf logs
iot lm [n]                      # mosquitto logs
iot li [n]                      # influxdb logs
iot lf [n]                      # grafana logs
iot ls [n]                      # set-schedule logs (Phase 6)
iot la [n]                      # all logs (default 10 each)

# Data
iot query [range] [rows]        # Query InfluxDB (default: 30m, 5 rows)
iot mqtt [topic] [count]        # Subscribe to MQTT topics
iot nuke                        # DELETE all data in govee bucket

# Config
iot env                         # Show .env file
iot conf                        # Show telegraf config
iot edit [file]                 # Edit a file (default: .env)
iot update                      # Refresh device name mappings
iot cron-on                     # Enable hourly device map updates
iot cron-off                    # Disable cron job

# Network
iot ip                          # Show VM IP address
iot web                         # Show all service URLs
iot tunnel                      # Start Cloudflare tunnel

# Maintenance
iot backup                      # Backup Grafana + InfluxDB volumes to ~/backups/

# Help
iot help                        # Show all commands
```

---

## DATA FLOW

### Current: Cloud Path (10-20 min latency)

```
Govee H5051 Sensor
  ↓ (BLE broadcast every ~1min)
Govee Gateway/Phone
  ↓ (uploads to cloud every ~10min)
Govee Cloud API (AWS IoT)
  ↓ (govee2mqtt polls every ~10min)
govee2mqtt container
  ↓ (publishes to: gv2mqtt/sensor/sensor-{MAC}-sensor{type}/state)
Mosquitto MQTT Broker
  ↓ (subscribes, enriches tags: device_name, room, sensor_type)
Telegraf
  ↓ (writes to InfluxDB)
InfluxDB (bucket: govee)
  ↓ (Flux queries)
Grafana
```

### Phase 4: BLE Path (<5 sec latency)

```
Govee H5051 Sensor
  ↓ (BLE broadcast every ~1min)
ESP32 BLE Gateway (OpenMQTTGateway)
  ↓ (publishes raw to: home/OpenMQTTGateway/BTtoMQTT/{MAC})
ble_decoder.py (systemd service)
  ↓ (decodes, publishes to: govee/ble/{room}/{metric})
Mosquitto MQTT Broker
  ↓ (Telegraf subscribes to BOTH cloud + BLE topics)
Telegraf (adds source tag: "cloud" or "ble")
  ↓
InfluxDB
  ↓
Grafana (shows both sources)
```

**Note**: Theengs Gateway on Windows available as fallback option.

---

## MQTT TOPICS

### Cloud Topics (current - working)
```
gv2mqtt/sensor/sensor-33FA4381ECA1010A-sensortemperature/state  → float (°F or °C)
gv2mqtt/sensor/sensor-33FA4381ECA1010A-sensorhumidity/state     → float (%)
```

### BLE Topics (Phase 4 - in progress)
```
home/OpenMQTTGateway/BTtoMQTT/4381ECA1010A    → JSON with manufacturerdata (from ESP32)
home/TheengsGateway/BTtoMQTT/4381ECA1010A     → JSON with manufacturerdata (fallback: Windows)
govee/ble/studown/temperature                  → float (°C from ble_decoder.py)
govee/ble/studown/humidity                     → float (%)
govee/ble/studown/battery                      → int (%)
```

---

## H5051 BLE DECODE FORMAT

**Example manufacturerdata**: `88ec004e06f00864e00101`

| Bytes | Format | Field | Example | Decoded |
|-------|--------|-------|---------|---------|
| 0-2 | - | Header | 88ec00 | - |
| 3-4 | uint16 LE | Temperature * 100 | 4e06 | 0x064E = 1614 = 16.14°C |
| 5 | uint8 | Humidity * 10 | f0 | 0xF0 = 240 = 24.0% |
| 6 | - | Unknown | 08 | - |
| 7 | uint8 | Battery % | 64 | 0x64 = 100% |

**Decoder logic** (used by ble_decoder.py):
```python
def decode_h5051(b):
    if len(b) < 8:
        return None
    temp_raw = b[3] | (b[4] << 8)
    return {
        "temp_c": temp_raw / 100.0,
        "humidity": b[5] / 10.0,
        "battery": b[7]
    }
```

**Other supported models**:
- H5074, H5075, H5072 use similar but slightly different decode logic

---

## TELEGRAF CONFIGURATION

### Current Structure (Cloud Only)

```toml
[agent]
  interval = "10s"
  omit_hostname = true

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "my-super-secret-token"
  organization = "home"
  bucket = "govee"

# Cloud source input
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "gv2mqtt/sensor/+/state"
  ]
  data_format = "value"
  data_type = "float"
  topic_tag = "topic"

# Extract device_id and sensor_type from topic
[[processors.regex]]
  [[processors.regex.tags]]
    key = "topic"
    pattern = "gv2mqtt/sensor/sensor-([A-F0-9]+)-sensor([a-z]+)/state"
    replacement = "${1}"
    result_key = "device_id"

  [[processors.regex.tags]]
    key = "topic"
    pattern = "gv2mqtt/sensor/sensor-([A-F0-9]+)-sensor([a-z]+)/state"
    replacement = "${2}"
    result_key = "sensor_type"

# Map device_id to friendly names and rooms
[[processors.enum]]
  [[processors.enum.mapping]]
    tag = "device_id"
    dest = "device_name"
    [processors.enum.mapping.value_mappings]
      "33FA4381ECA1010A" = "studio_5051_down"
      "17A8D003C1061976" = "h6076_1976"

  [[processors.enum.mapping]]
    tag = "device_id"
    dest = "room"
    [processors.enum.mapping.value_mappings]
      "33FA4381ECA1010A" = "studown"
      "17A8D003C1061976" = "unassigned"
```

**Auto-generated**: Device mappings updated hourly by `scripts/update-device-map.sh` which queries govee2mqtt API at localhost:8056.

### Planned Phase 4 Structure (Cloud + BLE)

Will add second MQTT input for BLE topics with `source = "ble"` tag, keeping existing cloud input with `source = "cloud"` tag. Both write to same measurement with same tags (device_name, room, sensor_type) plus source differentiator.

---

## DOCKER OPERATIONS

### docker-compose.yml

```yaml
version: '3.8'
services:
  govee2mqtt:
    image: ghcr.io/wez/govee2mqtt:latest
    container_name: govee2mqtt
    restart: unless-stopped
    env_file: .env
    network_mode: host              # Required for AWS IoT
    volumes:
      - govee2mqtt-data:/data

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf

  telegraf:
    image: telegraf:latest
    container_name: telegraf
    restart: unless-stopped
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro

  influxdb:
    image: influxdb:2
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    volumes:
      - influxdb-data:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=influxpass123
      - DOCKER_INFLUXDB_INIT_ORG=home
      - DOCKER_INFLUXDB_INIT_BUCKET=govee
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=my-super-secret-token

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana

volumes:
  govee2mqtt-data:
  influxdb-data:
  grafana-data:

### Phase 6 Addition to docker-compose.yml

```yaml
  set-schedule:
    build:
      context: ./services/set-schedule
      dockerfile: Dockerfile.showsite
    container_name: set-schedule
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./services/set-schedule:/app
    environment:
      - TZ=America/New_York
```
```

### Volume Naming
Docker volumes are prefixed with directory name:
- `dpx_govee_stack_grafana-data`
- `dpx_govee_stack_influxdb-data`
- `dpx_govee_stack_govee2mqtt-data`

**CRITICAL**: Renaming directory creates NEW volumes = data loss. Use `iot backup` first.

### Operations
- `/etc/docker/daemon.json`: `{"ipv6": false, "fixed-cidr-v6": ""}`
- Docker bridge sometimes goes DOWN after network changes, fix: `sudo systemctl restart docker`
- Full recreate needed for .env changes: `docker compose down && docker compose up -d`
- Restart sufficient for telegraf.conf changes: `docker compose restart telegraf`
- **Logs are lost on container recreate** (down/up cycle) - use `iot restart` when possible

---

## CRON JOBS

Device map update runs hourly:
```bash
0 * * * * /home/dubpixel/dpx_govee_stack/scripts/update-device-map.sh
```

Enable/disable:
```bash
iot cron-on   # Enable hourly updates
iot cron-off  # Disable cron job
```

---

## INSTALLED SERVICES

| Service | Status | Purpose |
|---------|--------|---------|
| SSH | enabled | Remote access |
| avahi-daemon | enabled | mDNS (*.local hostnames) |
| cloudflared | installed | Cloudflare tunnels (manual start) |
| tailscale | enabled | Mesh VPN |
| Docker | enabled | Container runtime |

---

## BLE GATEWAY OPTIONS

### Primary: ESP32 Hardware (OpenMQTTGateway)
**Production deployment** using custom ESP32-based boards with OpenMQTTGateway firmware.

**Hardware**: Custom DPX boards (ESP32-based, WiFi enabled)
**Firmware**: OpenMQTTGateway v1.8+ (esp32feather-ble build)
**Flash Tool**: Web installer at https://docs.openmqttgateway.com/upload/web-install.html
**MQTT Topics**: `home/OpenMQTTGateway/BTtoMQTT/{MAC}`
**Setup Time**: 5-10 minutes per gateway
**Advantages**: Dedicated hardware, low power, multi-site deployment ready

**Deployment Steps**:
1. Open web installer in Chrome/Edge
2. Select **esp32feather-ble** firmware (not esp32dev-ble)
3. Connect ESP32 via USB, click Install
4. Wait 2-3 min for flash
5. Connect to "OpenMQTTGateway" WiFi
6. Open 192.168.4.1, configure WiFi + MQTT broker
7. Verify: `iot mqtt "home/OpenMQTTGateway/BTtoMQTT/#"`

### Fallback: Theengs Gateway (Windows)
**Testing/fallback option** for Windows environments.

- Installed via pip on Windows with VS 2022 Build Tools C++
- Run manually: `python -m TheengsGateway -H <server-ip> -P 1883`
- Not a service yet, run manually in PowerShell
- H5051 NOT supported by Theengs decoder natively
- Raw manufacturerdata published to MQTT: `home/TheengsGateway/BTtoMQTT/{MAC}`
- Same ble_decoder.py handles both ESP32 and Theengs topics

---

## PHASE 3 COMPLETED WORK

### Documentation Created
- **README.md**: Quick start guide, commands, troubleshooting
- **ARCHITECTURE.md**: Data flows, MQTT topics, decode formats, technical details
- **ROADMAP.md**: Phase tracking, timeline, success metrics
- **CHANGELOG.md**: Version history
- **docs/GRAFANA_SETUP.md**: Manual Grafana datasource and dashboard setup

### File Organization
- Moved scripts to `scripts/` directory
- Created `docs/` directory for documentation
- Updated all path references in scripts and wrapper
- Fixed `iot` command wrapper (not symlink)
- Updated cron job paths

### Git & GitHub
- Initialized git repository
- Created comprehensive .gitignore
- Committed all work with detailed messages
- Pushed to public GitHub: https://github.com/dubpixel/dpx_showsite_ops
- Repository naming: underscores (dpx_showsite_ops) to match existing 80+ repos

### Testing & Validation
- All `iot` commands tested and working
- Device mapping updates working (hourly cron)
- Paths resolved correctly after reorganization
- Stack survives restart
- Backup process verified

---

## PHASE 4 - BLE GATEWAY INTEGRATION (IN PROGRESS)

### Goals
- Real-time sensor data (<5 second latency)
- Dual-source data (cloud + BLE)
- No dependency on Govee cloud uptime
- Better debugging (see raw sensor broadcasts)

### Completed
- ✅ ESP32 hardware gateway deployed (Gateway 1)
- ✅ OpenMQTTGateway firmware flashed (esp32feather-ble)
- ✅ WiFi + MQTT configuration complete
- ✅ Publishing raw BLE to `home/OpenMQTTGateway/BTtoMQTT/#`

### Tasks

#### 4.1: Deploy ble_decoder.py as systemd service
**File already exists** at: `~/dpx_govee_stack/scripts/ble_decoder.py` (needs verification/update)

Create systemd service:
```bash
sudo tee /etc/systemd/system/ble-decoder.service << 'EOF'
[Unit]
Description=Govee BLE Decoder
After=network.target mosquitto.service

[Service]
Type=simple
User=dubpixel
WorkingDirectory=/home/dubpixel/dpx_govee_stack/scripts
ExecStart=/usr/bin/python3 /home/dubpixel/dpx_govee_stack/scripts/ble_decoder.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable ble-decoder
sudo systemctl start ble-decoder
```

#### 4.2: Update Telegraf Config
Add BLE input alongside cloud input:

```toml
# BLE source input (add this)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "govee/ble/+/temperature",
    "govee/ble/+/humidity",
    "govee/ble/+/battery"
  ]
  data_format = "value"
  data_type = "float"
  topic_tag = "topic"
  [inputs.mqtt_consumer.tags]
    source = "ble"

# Cloud source (existing - add source tag)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = [
    "gv2mqtt/sensor/+/state"
  ]
  data_format = "value"
  data_type = "float"
  topic_tag = "topic"
  [inputs.mqtt_consumer.tags]
    source = "cloud"
```

**Note**: This requires updating `scripts/update-device-map.sh` to generate unified config with both inputs.

#### 4.3: Update Grafana Dashboards
- Add source filter to queries
- Show both cloud and BLE data on same graphs
- Add latency comparison panel
- Add source selector variable

#### 4.4: Testing
```bash
# Verify ESP32 gateway is publishing (primary)
iot mqtt "home/OpenMQTTGateway/BTtoMQTT/#" 10

# Or verify Theengs (fallback)
iot mqtt "home/TheengsGateway/BTtoMQTT/#" 10

# Verify decoder is running
sudo systemctl status ble-decoder
journalctl -u ble-decoder -f

# Verify decoded topics
iot mqtt "govee/ble/#" 10

# Check data in InfluxDB
iot query 5m 20 | grep source

# Verify both sources in Grafana
```

---

## PHASE 5 - NETWORK DEVICE BACKUPS (AFTER PHASE 4)

### Goals
- Automated daily backups of M4300 switch configs
- TFTP server for switch config uploads
- Version controlled config history
- Monitoring and alerting

### Tasks

#### 5.1: TFTP Server Setup
Add to docker-compose.yml:
```yaml
  tftp:
    image: pghalliday/tftp
    container_name: tftp
    restart: unless-stopped
    ports:
      - "69:69/udp"
    volumes:
      - ./tftp-data:/var/tftpboot
    environment:
      - TFTP_OPTIONS=--secure --create
```

#### 5.2: M4300 Backup Scripts
- Pull existing m4300-scripts repository
- Integrate with stack
- Schedule via cron
- Git commit configs after each backup

#### 5.3: Monitoring
- Track backup success/failure in InfluxDB
- Grafana dashboard for backup status
- Optional: Slack/email alerts on failures

---

## KEY LEARNINGS / GOTCHAS

- govee2mqtt publishes to `gv2mqtt/#` NOT `govee2mqtt/#`
- Govee API requires devices assigned to rooms to return data
- `RUST_LOG` env changes need full `down/up` cycle, not just restart
- **IPv6 on host causes govee2mqtt timeouts** — disable with sysctl
- Docker daemon.json IPv6 disable doesn't help govee2mqtt (uses `network_mode: host`)
- MQTT wildcard `+` catches non-numeric topics causing parse errors (harmless)
- govee2mqtt web API at port 8056 returns device JSON
- H5051 is BLE only, no LAN/IoT API
- **InfluxDB timestamps are UTC** — adjust for local timezone
- **Docker logs lost on recreate** — use `iot restart` not `down/up`
- **Hourly cron restarts Telegraf** if config changed
- **iot command needs wrapper script** not direct symlink
- **Underscores in hostnames are invalid** (RFC) — use dashes
- **Directory rename breaks Docker volumes** — backup first
- Sensor broadcast: BLE every ~1min, cloud upload every ~10min
- GitHub repo naming: use underscores to match existing projects

---

## GRAFANA SETUP (Manual Steps)

### Connect InfluxDB Datasource
1. Open Grafana: http://<server-ip>:3000 (credentials in .env)
2. Configuration → Data sources → Add data source → InfluxDB
3. Configure:
   - Query Language: **Flux**
   - URL: **http://influxdb:8086**
   - Organization: **home**
   - Token: **my-super-secret-token**
   - Default Bucket: **govee**
4. Save & Test

### Create Dashboard
Query to see room names:
```flux
from(bucket: "govee")
  |> range(start: -1h)
  |> filter(fn: (r) => r._measurement == "mqtt_consumer")
  |> keep(columns: ["room"])
  |> distinct(column: "room")
```

Temperature panel:
```flux
from(bucket: "govee")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r.sensor_type == "temperature")
  |> filter(fn: (r) => r.room == "studown")
```

Humidity panel:
```flux
from(bucket: "govee")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r.sensor_type == "humidity")
  |> filter(fn: (r) => r.room == "studown")
```

Full guide: `docs/GRAFANA_SETUP.md`

---

## QUICK REFERENCE

### Start/Stop Stack
```bash
iot up                          # Start everything
iot down                        # Stop everything
iot restart [service]           # Restart service(s)
iot status                      # Show status
```

### Monitor Data Flow
```bash
iot mqtt "gv2mqtt/#" 10         # Watch cloud topics
iot mqtt "govee/ble/#" 10       # Watch BLE topics (Phase 4)
iot query 1h 10                 # Query recent data
iot lt                          # Check telegraf logs
```

### Maintenance
```bash
iot backup                      # Backup volumes
iot update                      # Update device mappings
iot cron-on                     # Enable hourly updates
git add -A && git commit -m "..." && git push  # Push changes
```

### Troubleshooting
```bash
iot lg                          # govee2mqtt logs
iot validate                    # Check configuration
docker ps                       # Verify containers running
iot web                         # Show service URLs
```

---

## PHASE 6 - SET SCHEDULE INTEGRATION (NEW)

### Goal
Integrate Sean's `coachella_set_schedule` app for real-time show schedule tracking.

**Sean's Repo**: https://github.com/macswg/coachella_set_schedule

### What It Is
- FastAPI/Uvicorn web app
- Real-time schedule tracking for festival stages
- Records actual vs scheduled times
- Tracks "slip" (accumulated lateness)
- WebSocket sync across clients
- View-only and operator modes
- Google Sheets integration

### Integration Approach: Git Submodule + Docker Service

**Why**:
- Keeps Sean's repo separate (easy to pull his updates)
- No code duplication
- Automated deployment
- Runs as Docker service
- Managed with `iot` commands

### Implementation Steps

#### 6.1: Add as Git Submodule

```bash
cd ~/dpx_govee_stack
git submodule add https://github.com/macswg/coachella_set_schedule.git services/set-schedule
git add .gitmodules services/set-schedule
git commit -m "Add set-schedule as submodule (Phase 6)"
git push
```

#### 6.2: Create Dockerfile

Create `services/set-schedule/Dockerfile.showsite`:
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 6.3: Update docker-compose.yml

Add set-schedule service (see docker-compose section above)

#### 6.4: Update setup.sh

Add after directory creation:
```bash
if [ -f .gitmodules ]; then
    echo "Initializing submodules..."
    git submodule init
    git submodule update
    echo -e "${GREEN}✓${NC} Submodules initialized"
fi
```

#### 6.5: Update manage.sh

Add to log commands:
```bash
  ls)       docker logs set-schedule 2>&1 | tail -${2:-30} ;;
```

Update `la` to include set-schedule:
```bash
  la)       for c in govee2mqtt telegraf mosquitto influxdb grafana set-schedule; do ...
```

Update `web` command:
```bash
  web)
    # ... existing URLs ...
    echo "Set Schedule: http://$IP:8000"
    ;;
```

#### 6.6: User Workflow

**Initial setup**:
```bash
git clone --recurse-submodules https://github.com/dubpixel/dpx_showsite_ops.git
cd dpx_showsite_ops
./setup.sh
iot up
```

**Access**:
- View-only: http://<server-ip>:8000
- Operator: http://<server-ip>:8000/edit

**Update Sean's code**:
```bash
git submodule update --remote services/set-schedule
git add services/set-schedule
git commit -m "Update set-schedule"
git push
iot restart set-schedule
```

### Optional: InfluxDB Integration

Could log actual vs scheduled times to InfluxDB for historical slip tracking and Grafana dashboards.

---

## FILES TO CHECK/UPDATE FOR PHASES 4-6

**Phase 4**:
1. **scripts/ble_decoder.py** - Verify exists and is correct
2. **scripts/update-device-map.sh** - Update to generate unified telegraf config with BLE input
3. **telegraf/telegraf.conf** - Will be regenerated with both inputs
4. **Create**: `/etc/systemd/system/ble-decoder.service`
5. **Update**: Grafana dashboards to show source tag

**Phase 5**:
1. Add TFTP service to docker-compose.yml
2. Pull/integrate m4300-scripts repo
3. Create backup scheduling
4. Add monitoring to InfluxDB/Grafana

**Phase 6**:
1. Add git submodule for set-schedule
2. Create Dockerfile.showsite
3. Update docker-compose.yml
4. Update setup.sh for submodule init
5. Update manage.sh for set-schedule logs
6. Update docs/ROADMAP.md

---

## NEXT STEPS

### Immediate (Phase 4):
1. Verify ble_decoder.py script exists and is correct
2. Create systemd service for ble_decoder.py
3. Test Theengs → ble_decoder → MQTT flow
4. Update update-device-map.sh to generate unified Telegraf config
5. Restart Telegraf with new config
6. Verify data flowing with source tags
7. Update Grafana dashboards
8. Test and document

### Soon (Phase 5):
1. Add TFTP server to docker-compose.yml
2. Integrate M4300 backup scripts
3. Schedule backups via cron
4. Add monitoring integration

### Optional (Phase 6):
1. Add set-schedule as submodule
2. Create integration files
3. Update docker-compose.yml
4. Test deployment
5. Optional: InfluxDB integration for slip tracking

---

## CONTACT & CREDENTIALS SUMMARY

- **Server**: dubpixel@dpx-showsite-ops (<server-ip>)
- **GitHub**: https://github.com/dubpixel/dpx_showsite_ops
- **Git User**: i@dubpixel.tv / dubpixel
- **Govee**: dont fucking publish the credentials AI you dingus / (see .env)
- **Sean's Schedule Repo**: https://github.com/macswg/coachella_set_schedule
- **All service passwords**: See .env file (not tracked in git)

---

**END OF PHASE 3 CONTEXT**
**READY FOR PHASES 4, 5, 6**

Timeline:
- Phase 4: Starting immediately (BLE decoder)
- Phase 5: After Phase 4 (TFTP + M4300)
- Phase 6: Can be done anytime (independent of 4/5)
