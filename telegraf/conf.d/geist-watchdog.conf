# Geist Watchdog Environmental Monitor - SNMP Integration
# Collects temperature, humidity, and dewpoint data from internal and remote sensors
# Device IP: 192.168.1.214 - dpx-geist.local (hostname resolved via docker-compose extra_hosts)
# SNMP Community: public (read-only)
# Temperature values are in 0.1 degrees and need scaling

[[inputs.snmp]]
  agents = ["dpx-geist.local:161"]
  version = 2
  community = "public"
  interval = "30s"
  timeout = "5s"
  retries = 3
  agent_host_tag = "source"
  
  # Device metadata
  [[inputs.snmp.field]]
    name = "device_name"
    oid = "1.3.6.1.2.1.1.5.0"
    is_tag = true
  
  [[inputs.snmp.field]]
    name = "location"
    oid = "1.3.6.1.2.1.1.6.0"
    is_tag = true
  
  # Check temperature units (0=Celsius, 1=Fahrenheit)
  [[inputs.snmp.field]]
    name = "temp_units"
    oid = "1.3.6.1.4.1.21239.5.1.1.7.0"
    is_tag = true
  
  # Internal sensors (built into Watchdog)
  [[inputs.snmp.table]]
    name = "geist_internal"
    oid = "1.3.6.1.4.1.21239.5.1.2"
    
    [[inputs.snmp.table.field]]
      name = "sensor_name"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "available"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.4"
    
    [[inputs.snmp.table.field]]
      name = "temperature"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.5"
    
    [[inputs.snmp.table.field]]
      name = "humidity"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.6"
    
    [[inputs.snmp.table.field]]
      name = "dewpoint"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.7"
  
  # Remote temperature-only sensors
  [[inputs.snmp.table]]
    name = "geist_temp_remote"
    oid = "1.3.6.1.4.1.21239.5.1.4"
    
    [[inputs.snmp.table.field]]
      name = "sensor_name"
      oid = "1.3.6.1.4.1.21239.5.1.4.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "available"
      oid = "1.3.6.1.4.1.21239.5.1.4.1.4"
    
    [[inputs.snmp.table.field]]
      name = "temperature"
      oid = "1.3.6.1.4.1.21239.5.1.4.1.5"
  
  # Remote airflow/multi sensors (temp+humidity)
  [[inputs.snmp.table]]
    name = "geist_airflow_remote"
    oid = "1.3.6.1.4.1.21239.5.1.5"
    
    [[inputs.snmp.table.field]]
      name = "sensor_name"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "available"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.4"
    
    [[inputs.snmp.table.field]]
      name = "temperature"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.5"
    
    [[inputs.snmp.table.field]]
      name = "humidity"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.7"
    
    [[inputs.snmp.table.field]]
      name = "dewpoint"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.8"
  
  # Static tags
  [inputs.snmp.tags]
    source = "geist_watchdog"
    device_ip = "192.168.1.214"

# Scale temperature from tenths of degrees (725 â†’ 72.5) and filter unavailable sensors
[[processors.starlark]]
  namepass = ["geist_internal", "geist_temp_remote", "geist_airflow_remote"]
  source = '''
def apply(metric):
    # Filter out unavailable sensors (available=0 means disconnected)
    if metric.fields.get("available") == 0:
        return None  # Drop this metric
    
    # Scale temperature and dewpoint from tenths to whole degrees
    if "temperature" in metric.fields:
        metric.fields["temperature"] = metric.fields["temperature"] / 10.0
    if "dewpoint" in metric.fields:
        metric.fields["dewpoint"] = metric.fields["dewpoint"] / 10.0
    
    return metric
'''
  [processors.starlark.tagpass]
    source = ["geist_watchdog"]
