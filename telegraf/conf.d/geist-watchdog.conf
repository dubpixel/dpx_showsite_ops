# Geist Watchdog Environmental Monitor - SNMP Integration
# Collects temperature, humidity, and dewpoint data from internal and remote sensors
# Device IP: 10.0.10.162
# SNMP Community: public (read-only)
# Temperature values are in 0.1 degrees and need scaling

[[inputs.snmp]]
  agents = ["10.0.10.162:161"]
  version = 2
  community = "public"
  interval = "30s"
  timeout = "5s"
  retries = 3
  
  # Device metadata
  [[inputs.snmp.field]]
    name = "device_name"
    oid = "1.3.6.1.2.1.1.5.0"
    is_tag = true
  
  [[inputs.snmp.field]]
    name = "location"
    oid = "1.3.6.1.2.1.1.6.0"
    is_tag = true
  
  # Check temperature units (0=Celsius, 1=Fahrenheit)
  [[inputs.snmp.field]]
    name = "temp_units"
    oid = "1.3.6.1.4.1.21239.5.1.1.7.0"
    is_tag = true
  
  # Internal sensors (built into Watchdog)
  [[inputs.snmp.table]]
    oid = "1.3.6.1.4.1.21239.5.1.2"
    
    [[inputs.snmp.table.field]]
      name = "sensor_name"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "sensor_type"
      oid = ".1"  # Index becomes type tag
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "available"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.4"
    
    [[inputs.snmp.table.field]]
      name = "temperature"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.5"
    
    [[inputs.snmp.table.field]]
      name = "humidity"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.6"
    
    [[inputs.snmp.table.field]]
      name = "dewpoint"
      oid = "1.3.6.1.4.1.21239.5.1.2.1.7"
  
  # Remote temperature-only sensors
  [[inputs.snmp.table]]
    oid = "1.3.6.1.4.1.21239.5.1.4"
    
    [[inputs.snmp.table.field]]
      name = "sensor_name"
      oid = "1.3.6.1.4.1.21239.5.1.4.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "sensor_type"
      oid = ".1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "available"
      oid = "1.3.6.1.4.1.21239.5.1.4.1.4"
    
    [[inputs.snmp.table.field]]
      name = "temperature"
      oid = "1.3.6.1.4.1.21239.5.1.4.1.5"
  
  # Remote airflow/multi sensors (temp+humidity)
  [[inputs.snmp.table]]
    oid = "1.3.6.1.4.1.21239.5.1.5"
    
    [[inputs.snmp.table.field]]
      name = "sensor_name"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.3"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "sensor_type"
      oid = ".1"
      is_tag = true
    
    [[inputs.snmp.table.field]]
      name = "available"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.4"
    
    [[inputs.snmp.table.field]]
      name = "temperature"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.5"
    
    [[inputs.snmp.table.field]]
      name = "humidity"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.7"
    
    [[inputs.snmp.table.field]]
      name = "dewpoint"
      oid = "1.3.6.1.4.1.21239.5.1.5.1.8"
  
  # Static tags
  [inputs.snmp.tags]
    source = "geist_watchdog"
    device_ip = "10.0.10.162"

# Scale temperature from tenths of degrees (725 â†’ 72.5)
[[processors.math]]
  namepass = ["snmp"]  # Default measurement name when not specified
  order = 1
  
  [[processors.math.fields]]
    field = "temperature"
    operator = "/"
    value = 10.0
  
  [[processors.math.fields]]
    field = "dewpoint"
    operator = "/"
    value = 10.0
  
  [processors.math.tags]
    source = ["geist_watchdog"]

# Filter out unavailable sensors (available=0 means disconnected)
[[processors.starlark]]
  namepass = ["snmp"]
  order = 2
  source = '''
def apply(metric):
    if metric.fields.get("available") == 0:
        return None  # Drop this metric
    return metric
'''
  [processors.starlark.tagpass]
    source = ["geist_watchdog"]
